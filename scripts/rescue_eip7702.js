const{createWalletClient,createPublicClient,http,encodeFunctionData,parseAbi,formatEther}=require('viem');const{base}=require('viem/chains');const{privateKeyToAccount}=require('viem/accounts');const fs=require('fs');const path=require('path');require('dotenv').config();const H='0xD1D211831672a923F9679247688BF6DAA63c1718';const R='0xDc9d4232c1B9E4FbC7d426e6cbdB67EF07C4051C';const T='0xBA2cA14375b2cECA4f04350Bd014B375Bc014ad2';const U=`https://base-mainnet.g.alchemy.com/v2/${process.env.ALCHEMY_KEY}`;const EA=parseAbi(['function balanceOf(address) view returns (uint256)','function transfer(address to, uint256 amount) returns (bool)']);const RA=parseAbi(['function rescue()','function rescueETH()']);async function main(){console.log('== REALM Rescue via EIP-7702 ==\n');const hk=process.env.HACKED_PRIVATE_KEY;const gk=process.env.GAS_SENDER_PRIVATE_KEY;if(!hk||!gk){console.error('Set HACKED_PRIVATE_KEY and GAS_SENDER_PRIVATE_KEY in .env');process.exit(1)}const ha=privateKeyToAccount(hk.startsWith('0x')?hk:`0x${hk}`);const ga=privateKeyToAccount(gk.startsWith('0x')?gk:`0x${gk}`);console.log('Hacked:',ha.address);console.log('Gas sender:',ga.address);console.log('Receiver:',R,'\n');if(ha.address.toLowerCase()!==H.toLowerCase()){console.error('HACKED_PRIVATE_KEY mismatch!');process.exit(1)}const pc=createPublicClient({chain:base,transport:http(U)});const wc=createWalletClient({chain:base,transport:http(U)});const bal=await pc.readContract({address:T,abi:EA,functionName:'balanceOf',args:[H]});const geth=await pc.getBalance({address:ga.address});const nonce=await pc.getTransactionCount({address:H});console.log('REALM balance:',formatEther(bal));console.log('Gas sender ETH:',formatEther(geth));console.log('Nonce:',nonce);if(bal===0n){console.log('No tokens!');return}if(geth<500000000000000n){console.log('Need 0.0005 ETH min');return}console.log('\nDeploying TokenRescue...');const ap=path.join(__dirname,'..','artifacts','contracts','TokenRescue.sol','TokenRescue.json');if(!fs.existsSync(ap)){console.error('Run: npx hardhat compile');process.exit(1)}const ar=JSON.parse(fs.readFileSync(ap,'utf8'));const dh=await wc.deployContract({account:ga,abi:ar.abi,bytecode:ar.bytecode});console.log('Deploy TX:',dh);const dr=await pc.waitForTransactionReceipt({hash:dh});if(dr.status!=='success'){console.error('Deploy failed');process.exit(1)}const ra=dr.contractAddress;console.log('Deployed:',ra,'\n');console.log('Signing EIP-7702 auth...');const auth=await wc.signAuthorization({account:ha,contractAddress:ra});console.log('Signed! Nonce:',auth.nonce,'\n');console.log('Sending atomic rescue...');const cd=encodeFunctionData({abi:RA,functionName:'rescue'});try{const rh=await wc.sendTransaction({account:ga,authorizationList:[auth],to:H,data:cd,gas:200000n});console.log('TX:',rh);const rr=await pc.waitForTransactionReceipt({hash:rh});console.log('Status:',rr.status,'Block:',rr.blockNumber);if(rr.status==='success'){const nb=await pc.readContract({address:T,abi:EA,functionName:'balanceOf',args:[H]});const rb=await pc.readContract({address:T,abi:EA,functionName:'balanceOf',args:[R]});console.log('\nHacked:',formatEther(nb),'REALM');console.log('Receiver:',formatEther(rb),'REALM');if(nb===0n)console.log('\nRESCUE SUCCESSFUL!')}else{console.log('Reverted! Check basescan.org/tx/'+rh)}}catch(e){console.error('Failed:',e.message)}}main().catch(console.error);
